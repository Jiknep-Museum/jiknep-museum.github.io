<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"> 
        <link rel="icon" href="img/favicon.ico" />
        <title>JQNP Remix Viewer</title>
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="fonts/fonts.css">
    </head>
    <body>
        <div id="compteur" style="position: fixed; z-index: 5; color: aliceblue;">test</div>
        <script src="data.js"></script>
        <script>
            let alignTimer;

            function imgResize(elt){
                let naturalRatio = elt.naturalWidth / elt.naturalHeight;
                // try to scale verticaly first (70% of screen)
                let height = window.innerHeight * 0.70;
                let width = height * naturalRatio;

                if (width > window.innerWidth * 0.90){
                    width = window.innerWidth * 0.90;
                    height = width / naturalRatio; 
                }
                elt.style.height = (height|0) + "px" ;
                elt.style.width = (width|0) + "px" ;
            }
            function alignScroll() {
                document.getElementById("compteur").textContent = document.body.scrollTop;
                for (jqnp of document.querySelectorAll(".jqnp")){
                    if (jqnp.offsetTop + jqnp.offsetHeight/2 > pageYOffset) {
                        scrollTo({top: jqnp.offsetTop - 10, behavior:"smooth"});
                        break;
                    }
                }

            }
            function add_jqnep(jqnp, mur){
                // panneau général
                let jqnpElt = document.createElement("div");
                jqnpElt.className = "jqnp";
                mur.append(jqnpElt)

                // tableau
                let tableauElt = document.createElement("div");
                tableauElt.classList.add("tableau");
                jqnpElt.append(tableauElt);
                
                // image
                let imgElt = document.createElement("img");
                imgElt.src = jqnp.image_url;
                imgElt.onload = elt=>imgResize(elt.target);
                tableauElt.append(imgElt);

                // auteur
                let auteurElt = document.createElement("div");
                auteurElt.className = "auteur";
                let nbSignature = Array.from(jqnp.auteur)
                    .map(s=>s.charCodeAt(0))
                    .reduce((a,v)=>a+=v, 0) 
                    % 9 + 1;
                auteurElt.style.fontFamily = "sign" + nbSignature;
                auteurElt.textContent = jqnp.auteur;
                tableauElt.append(auteurElt);

                // plaque
                let plaqueElt = document.createElement("div");
                plaqueElt.className = "plaque";
                jqnpElt.append(plaqueElt);

                // nom
                let nomElt = document.createElement("div");
                nomElt.className = "nom";
                nomElt.append(document.createTextNode(jqnp.reponse[0]));
                plaqueElt.append(nomElt);

                // reactions
                let reactionsElt = document.createElement("div");
                reactionsElt.className = "reactions";
                let buildReacticon = (text,reacts) => {
                    let reactPart = document.createElement("div");
                    if (reacts.length > 0){
                        reactPart.append(document.createTextNode(text))
                        for (react of reacts) {
                            let reactElt = document.createElement("span");
                            reactElt.className = "react";
                            let reactStr = document.createElement("span");
                            reactStr.className = "react_str";
                            reactStr.append(document.createTextNode(react[0]))
                            let reactCount = document.createElement("span");
                            reactCount.className = "react_count";
                            reactCount.append(document.createTextNode(react[1]))
                            reactElt.append(reactStr);
                            reactElt.append(document.createTextNode(" "));
                            reactElt.append(reactCount)
                            reactPart.append(reactElt);
                        }
                    }
                    return reactPart;
                }
                reactionsElt.append(buildReacticon("réactions à l'image: ", jqnp.reactions_image));
                reactionsElt.append(buildReacticon("réactions au nom: ", jqnp.reactions_reponse));
                plaqueElt.append(reactionsElt);
            }

            let body = document.body;
            jqnps.reverse();
            for (jqnp of jqnps.splice(0,50)) {
                add_jqnep(jqnp,body);
            }
            window.onresize = evt => {
                for (img of document.querySelectorAll(".tableau img")) {
                    imgResize(img);
                }
            }
            let timer;
            document.body.onscroll = evt => {
                clearTimeout(timer);
                timer = setTimeout(alignScroll, 500);
            }
        
        </script>

    </body>
</html>